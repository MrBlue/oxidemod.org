---
layout: forums
title: 'Solved - Save data to SQLite database on unload'
breadcrumbs:
 - "Plugin Development": "/forums/plugin-development.105/"
 - "Rust Development": "/forums/rust-development.4/"
---
<div class="titleBar">
    <h1>
        <span class="prefix prefixGreen">Solved</span> <a href="{{ '/threads/save-data-to-sqlite-database-on-unload.22321/' | prepend: site.baseurl }}">Save data to SQLite database on unload</a>
    </h1>
    <p id="pageDescription" class="muted">Discussion in '<a href="{{ '/forums/rust-development.4/' | prepend: site.baseurl }}">Rust Development</a>' started by <a class="username"
            dir="auto">CombatTag</a>, <a href="{{ '/threads/save-data-to-sqlite-database-on-unload.22321/' | prepend: site.baseurl }}"><span class="DateTime" title="Dec 6, 2016 at 4:52 AM">Dec 6,
                2016</span></a>.
    </p>
</div>
<ol class="messageList" id="messageList">
    <li id="post-274120" class="message" data-author="CombatTag">
        <div class="messageUserInfo">
            <div class="messageUserBlock">
                <div class="avatarHolder">
                    <span class="helper"></span>
                    <a class="avatar Avm" data-avatarhtml="true"><img src="{{ '/assets/styles/oxide/logo.og.png' | prepend: site.baseurl }}" width="96" height="96" alt="CombatTag" /></a>
                </div>
                <h3 class="userText">
                    <a class="username" dir="auto">CombatTag</a>
                </h3>
                <span class="arrow"></span>
            </div>
        </div>
        <div class="messageInfo primaryContent">
            <div class="messageContent">
                <article>
                    <blockquote class="messageText SelectQuoteContainer ugc baseHtml"> I&#039;m trying to save all of my cached user data to a sqlite db when the server is unloaded. All of the sql
                        queries are done async so I have a action that is called once all of the users are unloaded. The problem is that after this method is called oxide will forcibly close the db
                        connection before all of the settings are saved so I can&#039;t save all of the settings. Here is the message of when the server closes the connection <div
                            class="bbCodeBlock bbCodeCode">
                            <div class="type">Code:</div>
                            {% raw %}<pre>[Oxide] 22:00 [Warning] Unclosed sqlite connection (Data Source=C:\Users\derek\Documents\rust\Windows Server\server\ctdev\oxide\data\CTGames.db;Version=3;), by plugin 'CTGames', closing...</pre>{% endraw %}
                        </div>I know this current solution is flawed and was just wondering if there was a standard solution to this or if anyone had experience with an issue like this that could
                        help.<br />
                        <div class="bbCodeBlock bbCodeCode">
                            <div class="type">Code:</div>
                            {% raw %}<pre>       void Unload()
        {
            unloadUsers(() =&gt;
            {
                _sqLite.CloseDb(_sqLiteConnection);
                foreach (var player in mainPlayers)
                {
                    CuiHelper.DestroyUi(player, &quot;Main&quot;);
                }                foreach (var arena in arenas.Values)
                {
                    arena.Unload();
                }
            });
        }</pre>{% endraw %}
                        </div>
                        <div class="messageTextEndMarker">&nbsp;</div>
                    </blockquote>
                </article>
            </div>
            <div class="messageMeta ToggleTriggerAnchor">
                <div class="privateControls">
                    <span class="item muted">
                        <span class="authorEnd"><a class="username author" dir="auto">CombatTag</a>,</span>
                        <a href="{{ '/threads/save-data-to-sqlite-database-on-unload.22321/' | prepend: site.baseurl }}" title="Permalink" class="datePermalink"><span class="DateTime"
                                title="Dec 6, 2016 at 4:52 AM">Dec 6, 2016</span></a>
                    </span>
                </div>
                <div class="publicControls">
                    <a href="{{ '/threads/save-data-to-sqlite-database-on-unload.22321/' | prepend: site.baseurl }}" title="Permalink" class="item muted postNumber hashPermalink OverlayTrigger"
                        data-href="posts/274120/permalink">#1</a>
                </div>
            </div>
        </div>
    </li>
    <li id="post-275884" class="message" data-author="CombatTag">
        <div class="messageUserInfo">
            <div class="messageUserBlock">
                <div class="avatarHolder">
                    <span class="helper"></span>
                    <a class="avatar Avm" data-avatarhtml="true"><img src="{{ '/assets/styles/oxide/logo.og.png' | prepend: site.baseurl }}" width="96" height="96" alt="CombatTag" /></a>
                </div>
                <h3 class="userText">
                    <a class="username" dir="auto">CombatTag</a>
                </h3>
                <span class="arrow"></span>
            </div>
        </div>
        <div class="messageInfo primaryContent">
            <div class="messageContent">
                <article>
                    <blockquote class="messageText SelectQuoteContainer ugc baseHtml"> Just thought I would post the solution I came up with for my problem. The SQL requests are done async so if you
                        attempt to make requests in the unload method chances are that oxide will destroy the SQL connection before the requests are completed. The way I worked around this is by
                        saving the cached user data to disk and then when the OnServerInit method is called I open a new SQL connection and save the necessary player data. <div
                            class="messageTextEndMarker">&nbsp;</div>
                    </blockquote>
                </article>
            </div>
            <div class="messageMeta ToggleTriggerAnchor">
                <div class="privateControls">
                    <span class="item muted">
                        <span class="authorEnd"><a class="username author" dir="auto">CombatTag</a>,</span>
                        <a href="{{ '/threads/save-data-to-sqlite-database-on-unload.22321/#post-275884' | prepend: site.baseurl }}" title="Permalink" class="datePermalink"><span class="DateTime"
                                title="Dec 11, 2016 at 11:20 PM">Dec 11, 2016</span></a>
                    </span>
                </div>
                <div class="publicControls">
                    <a href="{{ '/threads/save-data-to-sqlite-database-on-unload.22321/#post-275884' | prepend: site.baseurl }}" title="Permalink"
                        class="item muted postNumber hashPermalink OverlayTrigger" data-href="posts/275884/permalink">#2</a>
                </div>
            </div>
        </div>
    </li>
</ol>
